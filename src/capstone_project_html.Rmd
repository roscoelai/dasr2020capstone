---
title: "Analysing Dengue Cases in Singapore"
author: "Shayne, Roscoe, Anu"
date: "07 July 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

setwd(dirname(rstudioapi::getActiveDocumentContext()$path))

library(magrittr)
library(ggplot2)
```

```{r, import_moh_bulletin, include=FALSE}
get_moh_eweekly <- function(path) {
  #' Get Weekly Records from Ministry of Health (MOH)
  #' 
  #' @description
  #' Data from 2012-W01 to 2020-W26. Single Excel file with 1 sheet per year. 
  #' The link will download the file.
  #' 
  #' @details
  #' https://www.moh.gov.sg/resources-statistics/infectious-disease-statistics/2020/weekly-infectious-diseases-bulletin
  #'
  #' Up to W25: https://www.moh.gov.sg/docs/librariesprovider5/diseases-updates/weekly-infectious-disease-bulletin-year-2020ea2c0b1cec1549009844537d52f2377f.xlsx
  #'
  #' Up to W26: https://www.moh.gov.sg/docs/librariesprovider5/diseases-updates/weekly-infectious-disease-bulletin-year-2020ef64ac3712334d4dba1206de20313f78.xlsx
  #' 
  #' @param path The file path of the dataset.
  #' @return Combined weekly records.
  
  # Variation in column header names over the years must be standardized
  old_new = c(
    "Campylobacter enterosis" = "Campylobacter enteritis",
    "Campylobacterenterosis" = "Campylobacter enteritis",
    "Campylobacteriosis" = "Campylobacter enteritis",
    "Chikungunya Fever" = "Chikungunya",
    "Dengue Haemorrhagic Fever" = "DHF",
    "Dengue Fever" = "Dengue",
    "Hand, Foot and Mouth Disease" = "HFMD",
    "Hand, Foot Mouth Disease" = "HFMD",
    "Nipah virus infection" = "Nipah",
    "Viral Hepatitis A" = "Acute Viral Hepatitis A",
    "Viral Hepatitis E" = "Acute Viral Hepatitis E",
    "Zika Virus Infection" = "Zika",
    "Zika virus infection" = "Zika"
  )
  
  path %>% 
    readxl::excel_sheets() %>% 
    lapply(function(sheetname) {
      df = readxl::read_xlsx(path, sheetname, skip = 1)
      
      df$Year = sheetname
      
      # Start and End date formats are different for 2020
      if (sheetname == "2020") {
        df$Start = lubridate::dmy(df$Start)
        df$End = lubridate::dmy(df$End)
      }
      
      # Standardize column names
      mask = match(names(old_new), names(df))
      names(df)[na.omit(mask)] = old_new[which(!is.na(mask))]
      
      df
    }) %>% 
    dplyr::bind_rows() %>% 
    dplyr::mutate(Year = as.numeric(Year)) %>% 
    dplyr::select(Year, everything()) %>% 
    dplyr::arrange(Year, `Epidemiology Wk`)
}

bulletin <- get_moh_eweekly("../data/weekly-infectious-disease-bulletin-year-2020ef64ac3712334d4dba1206de20313f78.xlsx")
```

---

```{r, viz_ncases, echo=FALSE, fig.width=8, fig.height=4}
f1 <- bulletin %>% 
  tidyr::drop_na(Dengue) %>% 
  ggplot(aes(x = Start, y = Dengue)) + 
  geom_line(size = 1, color = "tomato3", alpha = 0.7) + 
  labs(title = "Weekly Dengue Cases from 2012 to 2020",
       subtitle = "Why is there a sudden spike in dengue cases this year?",
       x = "",
       y = "Number of Cases",
       caption = "Source: moh.gov.sg")

f1
```



## Overview of the Project
Dengue fever is a vector-borne infectious disease that are endemic in the tropical world. Singapore is one of several countries with high disease burden of dengue. In 2020, Singapore saw 1,158 dengue cases in a week of June - the highest number of weekly dengue cases ever recorded since 2014. Why is there a sudden spike in dengue cases this year?

### Questions
  - Does atmospheric variables influence the incidence of dengue cases?
    - Specifically, is higher humidity, precipitation, or temperature associated with increased numbers of dengue cases?
  - Can atmospheric variables predict the number of dengue cases?
  - Does the number of dengue cases increase with the number of COVID-19 cases?
  - Explain the different number of cases in different regions of Singapore



## Data
- [Daily records](http://www.weather.gov.sg/climate-historical-daily/) from Meteorological Service Singapore (MSS)
  - Relevant variables: Rainfall, Temperature
  - Data from 2012 to 2020 will be gathered from selected climate stations
    - [Climate station records](http://www.weather.gov.sg/wp-content/uploads/2016/12/Station_Records.pdf) indicate the following stations might have both rainfall and temperature data:
      - [x] Admiralty
      - [x] Ang Mo Kio
      - [x] Changi
      - [x] Choa Chu Kang (South)
      - [x] Clementi
      - [x] East Coast Parkway
      - [x] Jurong (West)
      - [ ] Jurong Island - EXCLUDED (too remote)
      - [x] Khatib
      - [x] Marina Barrage
      - [x] Newton
      - [x] Pasir Panjang
      - [ ] Pulau Ubin - EXCLUDED (too remote)
      - [x] Seletar
      - [ ] Sembawang - EXCLUDED (too many missing values)
      - [ ] Sentosa Island - EXCLUDED (too remote)
      - [x] Tai Seng
      - [x] Tengah
      - [ ] Tuas South - EXCLUDED (too remote)
- [Weekly infectious diesease bulletin (2012-W01 to 2020-W26)](https://www.moh.gov.sg/docs/librariesprovider5/diseases-updates/weekly-infectious-disease-bulletin-year-2020ef64ac3712334d4dba1206de20313f78.xlsx) from [Ministry of Health (MOH)](https://www.moh.gov.sg/resources-statistics/infectious-disease-statistics/2020/weekly-infectious-diseases-bulletin)
- Latest number of cases by named regions in Singapore from [National Environment Agency (NEA)](https://www.nea.gov.sg/dengue-zika/dengue/dengue-clusters)
- Yearly population distribution across named regions in Singapore
- COVID-19 cases (Apr - Jul 2020)

## Deprecated Data
- Monthly Air Temperature And Sunshine, Relative Humidity And Rainfall from [Singapore Department of Statistics (DOS)](https://www.tablebuilder.singstat.gov.sg/publicfacing/api/csv/title/15306.csv)
  - <u>Reason</u>: Higher resolution (daily) data available from MSS
  - Might reconsider if humidity data is needed
- Latest number of cases by regions with geocoordinates from [Data.gov.sg](https://data.gov.sg/dataset?q=Dengue)
  - <u>Reason</u>: Potentially **grandiose** (we've not learned leaflet yet!)
- Weekly case numbers (2012-W01 to 2020-W20) from [Data.gov.sg](https://data.gov.sg/dataset?q=Dengue)
  - <u>Reason</u>: More up-to-date data available from MOH



## Analysis Plan
- Transform dengue cases data
  - Converting epidemiology weeks cases to monthly cases for 2012 - 2020
  - Combine the different Excel sheets into a table 
- Compare the monthly cases across the years
  - Using repeated-measures ANOVA
  - Plotting
- To understand if atmospheric variables have an influence in the incidence of dengue cases
  - Correlate the weather variables with number of dengue cases monthly across the years
- To test if atmospheric variables predict number of dengue cases
  - Create models for regression
  - Compare the predicted value with actual value
- For the current trend, explain the differences between the number of cases in different regions
  - According to the news report, East region has the largest number of clusters compared to other parts of Singapore
  - In particular, does Marine Parade and Sembawang (or Queenstown?) have any differences in their weather variables?

### Considerations and limitations
- Time lag: Dengue cases manifest 1-2 weeks after infection
  - Timing adjustments have to be made for ostensibly associated variables
- Seasonal effects
  - "Vector" months (June, July, August, September, October)
- COVID-19 cases vs. dengue cases
  - 90% foreign workers, expect a correlation
  - Compare against number of cases from Apr - Jul 2020



# Preliminary Survey of Data Collected so Far

---

```{r, import_mss_records, include=FALSE}
get_mss_daily <- function(years, stations = "Changi") {
  #' Compile Daily Records from Meteorological Service Singapore (MSS)
  #' 
  #' @description Data from Jan 1980 to May 2020.
  #' 
  #' @details http://www.weather.gov.sg/climate-historical-daily/
  #' 
  #' @param years A vector of years of interest.
  #' @param stations A vector of climate station names. Defaults to "Changi".
  #' @return A table containing the combined historical daily records.
  #' @examples
  #' get_mss_daily(2014:2018)
  #' get_mss_daily(2012:2020, c("Changi", "Marine Parade", "Sembawang"))
  
  stations_vec = c(
    "Admiralty" = "104_",
    "Ang Mo Kio" = "109_",
    "Changi" = "24_",
    "Choa Chu Kang (South)" = "121_",
    "Clementi" = "50_",
    "East Coast Parkway" = "107_",
    "Jurong (West)" = "44_",
    # "Jurong Island" = "117_",
    "Khatib" = "122_",
    "Marina Barrage" = "108_",
    "Newton" = "111_",
    "Pasir Panjang" = "116_",
    # "Pulau Ubin" = "106_",
    # "Seletar" = "25_",
    "Sembawang" = "80_",
    # "Sentosa Island" = "60_",
    "Tai Seng" = "43_",
    "Tengah" = "23_"
    # "Tuas South" = "115_"
  )
  
  # List URLs with all climate station number-year-month combinations
  base_url = "http://www.weather.gov.sg/files/dailydata/DAILYDATA_S"
  station_nums = stations_vec[match(stations, names(stations_vec))]
  year_months = as.vector(t(outer(years, sprintf("%02d", 1:12), FUN = paste0)))
  station_year_months = t(outer(station_nums, year_months, FUN = paste0))
  
  urls = paste0(base_url, station_year_months, ".csv")
  
  dfs = urls %>% 
    lapply(function(url) {
      tryCatch(
        readr::read_csv(url) %>% 
          # Invalid multibyte characters "degree sign" in column headers
          # Different column names after Apr 2020
          # Manually label column names to facilitate row binding
          setNames(., c("Station",
                        "Year",
                        "Month",
                        "Day",
                        "Daily_Rainfall_Total_mm",
                        "Highest_30_Min_Rainfall_mm",
                        "Highest_60_Min_Rainfall_mm",
                        "Highest_120_Min_Rainfall_mm",
                        "Mean_Temperature_degC",
                        "Maximum_Temperature_degC",
                        "Minimum_Temperature_degC",
                        "Mean_Wind_Speed_kmh",
                        "Max_Wind_Speed_kmh")) %>% 
          # Invalid multibyte characters "em dash" as (missing) values
          # Coerced to NA
          dplyr::mutate_at(dplyr::vars(-Station), as.numeric),
        error = function(e) { NA })
      })
  
  dfs[!is.na(dfs)] %>% 
    dplyr::bind_rows() %>% 
    dplyr::mutate(Epiweek = lubridate::epiweek(paste(Year,
                                                     Month,
                                                     Day,
                                                     sep = "-"))) %>% 
    dplyr::select(Station, Epiweek, everything())
}

# weather <- get_mss_daily(years = 2012:2012)

# weather <- get_mss_daily(years = 2012:2020,
#                          stations = c("Admiralty",
#                                       "Ang Mo Kio",
#                                       "Changi",
#                                       "Choa Chu Kang (South)",
#                                       "Clementi",
#                                       "East Coast Parkway",
#                                       "Jurong (West)",
#                                       "Khatib",
#                                       "Marina Barrage",
#                                       "Newton",
#                                       "Pasir Panjang",
#                                       "Sembawang",
#                                       "Tai Seng",
#                                       "Tengah"))

weather <- readr::read_csv("../results/weather_daily_2012_2020.csv")
```

```{r, prep_overall, include=FALSE}
grouped_epiweek_changi <- weather %>%
  dplyr::filter(Station == "Changi") %>%
  dplyr::select(Year, Epiweek, matches("Rainfall_Total|Temperature"), -Station) %>% 
  dplyr::group_by(Year, Epiweek) %>% 
  dplyr::summarise(Rainfall = sum(Daily_Rainfall_Total_mm),
                   Temperature = mean(Mean_Temperature_degC))

df <- bulletin %>% 
  dplyr::rename(Epiweek = `Epidemiology Wk`) %>% 
  dplyr::select(Year, Epiweek, Start, Dengue) %>% 
  tidyr::drop_na() %>% 
  dplyr::left_join(grouped_epiweek_changi, c("Year", "Epiweek"))
```

```{r, viz_overall, echo=FALSE, warning=FALSE, fig.width=8, fig.height=6}
f2 <- df %>% 
  ggplot(aes(x = Start, y = Rainfall)) + 
  geom_line(size = 1, color = "deepskyblue4", alpha = 0.7) + 
  labs(title = "Total weekly Rainfall from 2012 to 2020",
       subtitle = "",
       x = "",
       y = "Total Rainfall (mm)",
       caption = "Source: moh.gov.sg")

f3 <- df %>% 
  ggplot(aes(x = Start, y = Temperature)) + 
  geom_line(size = 1, color = "darkgreen", alpha = 0.7) + 
  labs(title = "Average weekly Temperature from 2012 to 2020",
       subtitle = "",
       x = "",
       y = "Temperature (\u00b0C)",
       caption = "Source: moh.gov.sg")

gridExtra::grid.arrange(f1, f2, f3, nrow = 3, top = "Is there a relationship?")
```

---

```{r prep_geo, include=FALSE}
station_positions <- readr::read_csv("../data/Station_Records.csv") %>% 
  tidyr::drop_na(`Period of Daily Rain Records`,
                 `Period of Mean Temperature`,
                 `Period of Max and Min Temperature`) %>% 
  dplyr::rename(Lat = `Lat.(N)`,
                Long = `Long. (E)`) %>% 
  dplyr::mutate(Station = paste(Station, "Climate Station")) %>% 
  dplyr::select(Station, Lat, Long) %>%
  dplyr::arrange(Station)



lspdf <- rgdal::readOGR("../data/master-plan-2019-planning-area-boundary-no-sea/planning-boundary-area.kml")

lspdf@data <- lspdf@data %>% 
  dplyr::mutate(area_name = gsub(".*?<td>(.*?)</td>.*", "\\1", Description) %>% 
                  tolower() %>% 
                  tools::toTitleCase())

centers <- rgeos::gCentroid(lspdf, byid = T)
centers$region <- lspdf@data$area_name

pal <- leaflet::colorFactor(RColorBrewer::brewer.pal(length(lspdf), "Set3"), NULL)
```

## Climate Stations with Planning Areas Overlay

```{r, viz_geo, echo=FALSE}
lspdf %>% 
  leaflet::leaflet(width = "100%") %>%
  leaflet::addTiles() %>%
  leaflet::addPolygons(stroke = T,
                       opacity = 1,
                       # color = "black",
                       smoothFactor = 0.5,
                       fillOpacity = 0.5,
                       fillColor = ~pal(area_name),
                       weight = 1,
                       popup = ~as.character(area_name)) %>% 
  leaflet::addLabelOnlyMarkers(data = centers,
                               lng = centers$x,
                               lat = centers$y,
                               label = ~region,
                               labelOptions = leaflet::labelOptions(
                                 noHide = T,
                                 textOnly = T,
                                 textsize = "10px",
                                 direction = "auto")
                               ) %>% 
  leaflet::addMarkers(data = station_positions,
                      lng = ~Long,
                      lat = ~Lat,
                      popup = ~as.character(Station),
                      label = ~as.character(Station),
                      labelOptions = leaflet::labelOptions(noHide = F))
```

---

```{r prep_weather_monthly, include=FALSE}
grouped_month <- weather %>%
  dplyr::select(Station, Year, Month, matches("Rainfall_Total|Temperature")) %>% 
  dplyr::group_by(Station, Year, Month) %>% 
  dplyr::summarise(Rainfall_Total = sum(Daily_Rainfall_Total_mm),
                   Mean_Temperature = mean(Mean_Temperature_degC),
                   Maximum_Temperature = mean(Maximum_Temperature_degC),
                   Minimum_Temperature = mean(Minimum_Temperature_degC))
```

```{r, viz_weather_monthly, echo=FALSE, fig.width=8, fig.height=5}
w1 <- grouped_month %>% 
  dplyr::filter(Station == "Changi") %>% 
  tibble::add_column(x = 1:nrow(.)) %>% 
  dplyr::select(-Rainfall_Total) %>% 
  tidyr::gather("Variable",
                "Value",
                Mean_Temperature,
                Maximum_Temperature,
                Minimum_Temperature) %>% 
  ggplot(aes(x = x, y = Value, color = Variable)) + 
  scale_x_continuous(breaks = c(1 + 12 * (0:8)),
                     label = c(2012:2020)) +
  geom_line(size = 1) + 
  labs(title = "Average monthly Temperature from 2012 to 2020",
       subtitle = "",
       x = "",
       y = "Temperature (\u00b0C)",
       caption = "Source: weather.gov.sg")

w2 <- grouped_month %>% 
  dplyr::select(Station, Year, Month, Rainfall_Total) %>% 
  dplyr::mutate(x = (Year - 2012) * 12 + Month) %>% 
  ggplot(aes(x = x, y = Rainfall_Total, color = Station)) + 
  scale_x_continuous(breaks = c(1 + 12 * (0:8)),
                     label = c(2012:2020)) +
  geom_line(size = 1, alpha = 0.5) + 
  labs(title = "Total monthly Rainfall from 2012 to 2020",
       subtitle = "",
       x = "",
       y = "Total Rainfall (mm)",
       caption = "Source: weather.gov.sg")

gridExtra::grid.arrange(w1, w2, nrow = 2)
```

---

```{r, viz_density, echo=FALSE, warning=FALSE, fig.width=8, fig.height=3}
{
  par(mfrow = c(1, 3))
  plot(density(df$Dengue[!is.na(df$Dengue)]), main = "Cases")
  plot(density(df$Rainfall[!is.na(df$Rainfall)]), main = "Rainfall")
  plot(density(df$Temperature[!is.na(df$Temperature)]), main = "Temperature")
}
```
