---
title: "Analysing Dengue Cases in Singapore"
author: "Shayne, Roscoe, Anu"
date: "09 July 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

setwd(dirname(rstudioapi::getActiveDocumentContext()$path))

library(magrittr)
library(ggplot2)
```

```{r, bulletin_import_tidy, include=FALSE}
import_moh_eweekly <- function(path) {
  #' Weekly Infectious Diseases Bulletin
  #' 
  #' @description
  #' Weekly infectious diseases bulletin from the Ministry of Health (MOH). 
  #' Data from 2012-W01 to 2020-W26. Follow the URLs below to download the 
  #' dataset (single Excel file; 1 year's data per sheet). This function will 
  #' combine all data into a single table.
  #' 
  #' Number of cases:
  #' \enumerate{
  #'   \item Cholera
  #'   \item Paratyphoid
  #'   \item Typhoid
  #'   \item Acute Viral Hepatitis A
  #'   \item Acute Viral Hepatitis E
  #'   \item Poliomyelitis
  #'   \item Plague
  #'   \item Yellow Fever
  #'   \item Dengue
  #'   \item DHF
  #'   \item Malaria
  #'   \item Chikungunya
  #'   \item HFMD
  #'   \item Diphtheria
  #'   \item Measles
  #'   \item Mumps
  #'   \item Rubella
  #'   \item SARS
  #'   \item Nipah
  #'   \item Acute Viral hepatitis B
  #'   \item Encephalitis
  #'   \item Legionellosis
  #'   \item Campylobacter enteritis
  #'   \item Acute Viral hepatitis C
  #'   \item Leptospirosis
  #'   \item Melioidosis
  #'   \item Meningococcal Infection
  #'   \item Pertussis
  #'   \item Pneumococcal Disease (invasive)
  #'   \item Haemophilus influenzae type b
  #'   \item Salmonellosis(non-enteric fevers)
  #'   \item Avian Influenza
  #'   \item Zika
  #'   \item Ebola Virus Disease
  #'   \item Japanese Encephalitis
  #'   \item Tetanus
  #'   \item Botulism
  #'   \item Murine Typhus
  #' }
  #' 
  #' Average daily numbers (of polyclinic attendances):
  #' \enumerate{
  #'   \item Acute Upper Respiratory Tract infections
  #'   \item Acute Conjunctivitis
  #'   \item Acute Diarrhoea
  #'   \item Chickenpox
  #' }
  #' 
  #' @details
  #' \href{https://www.moh.gov.sg/resources-statistics/infectious-disease-statistics/2020/weekly-infectious-diseases-bulletin}{MOH Weekly Infectious Disease Bulletin}
  #'
  #' \href{https://www.moh.gov.sg/docs/librariesprovider5/diseases-updates/weekly-infectious-disease-bulletin-year-2020ef64ac3712334d4dba1206de20313f78.xlsx}{Latest data (as of 08 Jul 2020)}
  #' 
  #' @param path The file path of the dataset.
  #' @return A table containing the combined weekly records.
  
  # There are variations in some column names over the years
  # The headers for 2020 will be chosen as the standard
  colnames_2020 = c(
    "Campylobacter enterosis" = "Campylobacter enteritis",
    "Campylobacterenterosis" = "Campylobacter enteritis",
    "Campylobacteriosis" = "Campylobacter enteritis",
    "Chikungunya Fever" = "Chikungunya",
    "Dengue Haemorrhagic Fever" = "DHF",
    "Dengue Fever" = "Dengue",
    "Hand, Foot and Mouth Disease" = "HFMD",
    "Hand, Foot Mouth Disease" = "HFMD",
    "Nipah virus infection" = "Nipah",
    "Viral Hepatitis A" = "Acute Viral Hepatitis A",
    "Viral Hepatitis E" = "Acute Viral Hepatitis E",
    "Zika Virus Infection" = "Zika",
    "Zika virus infection" = "Zika"
  )
  
  path %>% 
    readxl::excel_sheets() %>%  # Get all sheetnames in an Excel file
    lapply(function(sheetname) {
      # The first rows are titles, not column headers, so skip = 1
      df = readxl::read_xlsx(path, sheetname, skip = 1)
      
      # The sheetnames happen to be the years
      df$Year = sheetname
      
      # Start and End date formats are different for 2020
      if (sheetname == "2020") {
        df$Start = lubridate::dmy(df$Start)
        df$End = lubridate::dmy(df$End)
      }
      
      # Standardize column names
      mask = match(names(colnames_2020), names(df))
      names(df)[na.omit(mask)] = colnames_2020[which(!is.na(mask))]
      
      df
    }) %>% 
    dplyr::bind_rows() %>%  # Will work properly if columns are standardized
    dplyr::mutate(Year = as.numeric(Year)) %>% 
    dplyr::select(Year, everything()) %>% 
    dplyr::arrange(Year, `Epidemiology Wk`)
}

# bulletin <- import_moh_eweekly("../data/weekly-infectious-disease-bulletin-year-2020ef64ac3712334d4dba1206de20313f78.xlsx")

bulletin <- readr::read_csv("../data/moh_weekly_bulletin_2012_2020_tidy_20200708.csv")
```

---

```{r, bulletin_visualize, echo=FALSE, fig.width=8, fig.height=4}
f1 <- bulletin %>% 
  tidyr::drop_na(Dengue) %>% 
  ggplot(aes(x = Start, y = Dengue)) + 
  geom_line(size = 1, color = "tomato3", alpha = 0.7) + 
  labs(title = "Weekly Dengue Cases from 2012 to 2020",
       subtitle = "Why is there a sudden spike in dengue cases this year?",
       x = "",
       y = "Number of Cases",
       caption = "Source: moh.gov.sg")

f1
```



## Overview of the Project
Dengue fever is a vector-borne infectious disease that are endemic in the tropical world. Singapore is one of several countries with high disease burden of dengue. In 2020, Singapore saw 1,158 dengue cases in a week of June - the highest number of weekly dengue cases ever recorded since 2014. Why is there a sudden spike in dengue cases this year?

### Questions
  - Does atmospheric variables influence the incidence of dengue cases?
    - Specifically, is higher humidity, precipitation, or temperature associated with increased numbers of dengue cases?
  - Can atmospheric variables predict the number of dengue cases?
  - Does the number of dengue cases increase with the number of COVID-19 cases?
  - Explain the different number of cases in different regions of Singapore



## Data
- [Daily records](http://www.weather.gov.sg/climate-historical-daily/) from Meteorological Service Singapore (MSS)
  - Relevant variables: Rainfall, Temperature
  - Data from 2012 to 2020 will be gathered from selected climate stations
    - [Climate station records](http://www.weather.gov.sg/wp-content/uploads/2016/12/Station_Records.pdf) indicate the following stations might have both rainfall and temperature data:
      - [x] Admiralty
      - [x] Ang Mo Kio
      - [x] Changi
      - [x] Choa Chu Kang (South)
      - [x] Clementi
      - [x] East Coast Parkway
      - [x] Jurong (West)
      - [x] Khatib
      - [x] Marina Barrage
      - [x] Newton
      - [x] Pasir Panjang
      - [x] Sembawang
      - [x] Tai Seng
      - [x] Tengah
  - [ ] Aggregate data to months
    - Mean/Median rainfall
    - Mean/Median temperature
    - Temperature range (max-min)
- [Weekly infectious diesease bulletin (2012-W01 to 2020-W26)](https://www.moh.gov.sg/docs/librariesprovider5/diseases-updates/weekly-infectious-disease-bulletin-year-2020ef64ac3712334d4dba1206de20313f78.xlsx) from [Ministry of Health (MOH)](https://www.moh.gov.sg/resources-statistics/infectious-disease-statistics/2020/weekly-infectious-diseases-bulletin)
  - [ ] Aggregate data to months
- Latest number of cases by named regions in Singapore from [National Environment Agency (NEA)](https://www.nea.gov.sg/dengue-zika/dengue/dengue-clusters)
- Yearly population distribution across named regions in Singapore
- COVID-19 cases (Apr - Jul 2020)
- Latest number of cases by regions with geocoordinates from [Data.gov.sg](https://data.gov.sg/dataset?q=Dengue)

## Deprecated Data
- Monthly Air Temperature And Sunshine, Relative Humidity And Rainfall from [Singapore Department of Statistics (DOS)](https://www.tablebuilder.singstat.gov.sg/publicfacing/api/csv/title/15306.csv)
  - <u>Reason</u>: Higher resolution (daily) data available from MSS
  - Might reconsider if humidity data is needed
  - <u>Reason</u>: Potentially **grandiose** (we've not learned leaflet yet!)
- Weekly case numbers (2012-W01 to 2020-W20) from [Data.gov.sg](https://data.gov.sg/dataset?q=Dengue)
  - <u>Reason</u>: More up-to-date data available from MOH



## Analysis Plan
- Transform dengue cases data
  - Converting epidemiology weeks cases to monthly cases for 2012 - 2020
  - Combine the different Excel sheets into a table 
- Compare the monthly cases across the years
  - Using repeated-measures ANOVA
  - Plotting
- To understand if atmospheric variables have an influence in the incidence of dengue cases
  - Correlate the weather variables with number of dengue cases monthly across the years
- To test if atmospheric variables predict number of dengue cases
  - Create models for regression
  - Compare the predicted value with actual value
- For the current trend, explain the differences between the number of cases in different regions
  - According to the news report, East region has the largest number of clusters compared to other parts of Singapore
  - In particular, does Marine Parade and Sembawang (or Queenstown?) have any differences in their weather variables?

### Address these
- Seasonal effects
  - "Vector" months (June, July, August, September, October)
- Time lag: Dengue cases manifest 1-2 weeks after infection
  - Timing adjustments have to be made for ostensibly associated variables
- COVID-19 cases vs. dengue cases
  - 90% foreign workers, expect a correlation
  - Compare against number of cases from Apr - Jul 2020



# Explore

---

```{r, weather_import_tidy, include=FALSE}
import_mss_daily <- function(years, stations = "Changi") {
  #' Historical Daily Weather Records
  #' 
  #' @description
  #' Daily weather records from the Meteorological Service Singapore (MSS). 
  #' Data from January 1980 to June 2020 potentially available. This function 
  #' will combine data from a range of years, from a list of climate stations 
  #' (refer to the list below for recognized stations). Epidemiological years 
  #' and weeks will be calculated using available date information.
  #' 
  #' Recognized climate stations:
  #' \enumerate{
  #'   \item Admiralty
  #'   \item Ang Mo Kio
  #'   \item Changi
  #'   \item Choa Chu Kang (South)
  #'   \item Clementi
  #'   \item East Coast Parkway
  #'   \item Jurong (West)
  #'   \item Jurong Island
  #'   \item Khatib
  #'   \item Marina Barrage
  #'   \item Newton
  #'   \item Pasir Panjang
  #'   \item Pulau Ubin
  #'   \item Seletar
  #'   \item Sembawang
  #'   \item Sentosa Island
  #'   \item Tai Seng
  #'   \item Tengah
  #'   \item Tuas South
  #' }
  #' 
  #' Variables:
  #' \enumerate{
  #'   \item Daily_Rainfall_Total_mm
  #'   \item Highest_30_Min_Rainfall_mm
  #'   \item Highest_60_Min_Rainfall_mm
  #'   \item Highest_120_Min_Rainfall_mm
  #'   \item Mean_Temperature_degC
  #'   \item Maximum_Temperature_degC
  #'   \item Minimum_Temperature_degC
  #'   \item Mean_Wind_Speed_kmh
  #'   \item Max_Wind_Speed_kmh
  #' }
  #' 
  #' @details
  #' \href{http://www.weather.gov.sg/climate-historical-daily/}{MSS Daily Records}
  #' 
  #' \href{http://www.weather.gov.sg/wp-content/uploads/2016/12/Station_Records.pdf}{List of stations, weather parameters and periods of records}
  #' 
  #' @param years A vector of years of interest.
  #' @param stations A vector of climate station names. Defaults to "Changi".
  #' @return A table containing the combined daily records.
  #' @examples
  #' import_mss_daily(2012:2020, c("Changi", "Clementi", "Khatib", "Newton"))
  
  # MSS is nice enough to have their data accessible as .csv files, and they 
  #   have a systematic naming scheme! That greatly simplifies collection of 
  #   data. From the list of stations, weather parameters and periods of 
  #   records, the following climate stations have been indicated to have 
  #   captured temperature and wind speed data, in addition to rainfall data 
  #   which was common to all stations. Their names are associated with their 
  #   numbers in the following vector.
  
  stations_lookup = c(
    "Admiralty" = 104,
    "Ang Mo Kio" = 109,
    "Changi" = 24,
    "Choa Chu Kang (South)" = 121,
    "Clementi" = 50,
    "East Coast Parkway" = 107,
    "Jurong (West)" = 44,
    "Jurong Island" = 117,
    "Khatib" = 122,
    "Marina Barrage" = 108,
    "Newton" = 111,
    "Pasir Panjang" = 116,
    "Pulau Ubin" = 106,
    "Seletar" = 25,
    "Sembawang" = 80,
    "Sentosa Island" = 60,
    "Tai Seng" = 43,
    "Tengah" = 23,
    "Tuas South" = 115
  )
  
  # The full URL to each .csv file follows a certain convention:
  # - The base URL is: "http://www.weather.gov.sg/files/dailydata/DAILYDATA_S"
  # - Format: "<base URL><station number>_<YYYY><MM>.csv"
  # - We need to enumerate all <station number>-<year>-<month> combinations
  
  # Station numbers:
  # We find the station numbers from the user-input station names using the 
  #   look-up vector given above.
  station_nums = stations %>% 
    match(., names(stations_lookup)) %>%  # Find index positions of matches
    stations_lookup[.]  # Retrieve cognate station numbers
  
  # Year-month combinations:
  # We will enumerate all user-input years with all 12 months by taking the 
  #   Cartesian product of the user-input years with a vector of 12 months 
  #   (from "01" to "12", with leading zeroes). Some stations might not have 
  #   data for certain months (so the .csv file does not exist), but we'll 
  #   handle that using tryCatch().
  year_months = years %>% 
    outer(sprintf("%02d", 1:12),  # Use sprintf() to left pad with "0"
          FUN = paste0) %>%  # Cartesian product using paste0()
    sort()  # Flatten and arrange in chronological order
  
  # Station number-year-month combinations:
  # We now take the Cartesian product of the station numbers and the year-month 
  #   combinations, remembering the underscore ("_") between the station number 
  #   and the year.
  station_year_months = station_nums %>% 
    outer(year_months, FUN = paste, sep = "_") %>%  # Argument passing magic!
    sort()  # This would also order by station number, but that's fine
  
  # Full URLs list:
  # We simply prefix with the base URL and suffix with ".csv"
  urls = paste0("http://www.weather.gov.sg/files/dailydata/DAILYDATA_S",
                station_year_months,
                ".csv")
  
  # Now we (attempt to) read data from each URL into a list of tables:
  # It was noted that in some of the column headers, a variant of the "degree 
  #   sign" was used (for the unit degrees Celsius). These were recognized as 
  #   invalid multibyte characters, and somehow made the table contents 
  #   inaccessible. Furthermore, the column headers had slightly different 
  #   wordings after April 2020. Thus, it was decided that the columns names 
  #   would be manually set as each table was read in order to address the 
  #   problems as well as facilitate dplyr::bind_rows() downstream.
  # It was also found that the table might contain the "em dash" (long dash) 
  #   character, also recognized as an invalid multibyte character, to denote 
  #   missing values or empty cells. These would be converted to NA upon type 
  #   coercion using as.numeric().
  dfs = urls %>% 
    lapply(function(url) {
      tryCatch(
        readr::read_csv(url) %>% 
          setNames(., c("Station",
                        "Year",
                        "Month",
                        "Day",
                        "Daily_Rainfall_Total_mm",
                        "Highest_30_Min_Rainfall_mm",
                        "Highest_60_Min_Rainfall_mm",
                        "Highest_120_Min_Rainfall_mm",
                        "Mean_Temperature_degC",
                        "Maximum_Temperature_degC",
                        "Minimum_Temperature_degC",
                        "Mean_Wind_Speed_kmh",
                        "Max_Wind_Speed_kmh")) %>% 
          dplyr::mutate_at(dplyr::vars(-Station), as.numeric),
        error = function(e) { NA })
    })
  
  # Some of the URLs might point to files that do not exist. The list would 
  #   contain a NA for those positions. These have to be deselected before 
  #   applying dplyr::bind_rows().
  # The dates, epidemiological years, and epidemiological weeks are calculated 
  #   from the year, month, and day given for each row.
  dfs[!is.na(dfs)] %>% 
    dplyr::bind_rows() %>% 
    dplyr::mutate(Date = lubridate::ymd(paste(Year, Month, Day, sep = "-")),
                  Epiyear = lubridate::epiyear(Date),
                  Epiweek = lubridate::epiweek(Date)) %>% 
    dplyr::select(Station,
                  Epiyear,
                  Epiweek,
                  Date,
                  everything(),
                  -Year,
                  -Month,
                  -Day) %>% 
    dplyr::arrange(Station, Date)
}

# weather <- import_mss_daily(years = 2012:2020,
#                          stations = c("Admiralty",
#                                       "Ang Mo Kio",
#                                       "Changi",
#                                       "Choa Chu Kang (South)",
#                                       "Clementi",
#                                       "East Coast Parkway",
#                                       "Jurong (West)",
#                                       "Khatib",
#                                       "Marina Barrage",
#                                       "Newton",
#                                       "Pasir Panjang",
#                                       "Sembawang",
#                                       "Tai Seng",
#                                       "Tengah"))

weather <- readr::read_csv("../data/mss_daily_2012_2020_14stations_20200709.csv")
```

```{r geo_import_tidy, include=FALSE}
import_kmls <- function(paths) {
  do.call("rbind", lapply(paths, rgdal::readOGR))
}

calc_centroids <- function(spdf) {
  spdf@data = spdf@data %>% 
    dplyr::bind_cols(as.data.frame(rgeos::gCentroid(spdf, byid = T))) %>% 
    dplyr::rename(cx = x,
                  cy = y)
  spdf
}

extract_labels <- function(spdf) {
  spdf@data$parea <-
    gsub(".*?<td>(.*?)</td>.*", "\\1", spdf@data$Description) %>% 
    tolower() %>% 
    tools::toTitleCase()
  spdf
}

extract_ncases <- function(spdf) {
  # spdf@data <- spdf@data %>% 
  #   tidyr::extract(Description, "ncases", ".*Cases : (\\d+).*", convert = T)
  spdf@data$ncases <-
    as.numeric(gsub(".*Cases : (\\d+).*", "\\1", spdf@data$Description))
  spdf
}

calc_indiv_coords <- function(spdf) {
  df = data.frame(matrix(ncol = 3, nrow = sum(spdf@data$ncases)))
  names(df) <- c("dup", "cx", "cy")
  
  i = 1L
  for (j in 1:nrow(spdf@data)) {
    for (k in 1:spdf@data[j, "ncases"]) {
      df[i, "dup"] = k
      df[i, "cx"] = spdf@data[j, "cx"]
      df[i, "cy"] = spdf@data[j, "cy"]
      i = i + 1L
    }
  }
  
  df
}

# Import ----
dengue_clusters <- import_kmls(c(
  "../data/dengue-cases-central/dengue-cases-central-kml.kml",
  "../data/dengue-cases-north-east/dengue-cases-north-east-kml.kml",
  "../data/dengue-cases-south-east/dengue-cases-south-east-kml.kml",
  "../data/dengue-cases-south-west/dengue-cases-south-west-kml.kml"
))

planning_areas <- import_kmls("../data/master-plan-2019-planning-area-boundary-no-sea/planning-boundary-area.kml")

climate_stations <- readr::read_csv("../data/Station_Records.csv") %>% 
  tidyr::drop_na(`Period of Daily Rain Records`,
                 `Period of Mean Temperature`,
                 `Period of Max and Min Temperature`) %>% 
  dplyr::rename(Lat = `Lat.(N)`,
                Long = `Long. (E)`) %>% 
  dplyr::filter(Station %in% c("Admiralty",
                               "Ang Mo Kio",
                               "Changi",
                               "Choa Chu Kang (South)",
                               "Clementi",
                               "East Coast Parkway",
                               "Jurong (West)",
                               "Khatib",
                               "Marina Barrage",
                               "Newton",
                               "Pasir Panjang",
                               "Sembawang",
                               "Tai Seng",
                               "Tengah")) %>% 
  dplyr::mutate(Station = paste(Station, "Climate Station")) %>% 
  dplyr::select(Station, Lat, Long) %>%
  dplyr::arrange(Station)

# Transform ----
dengue_clusters <- dengue_clusters %>% 
  extract_ncases() %>% 
  calc_centroids()

dengue_cases <- calc_indiv_coords(dengue_clusters)

planning_areas <- planning_areas %>% 
  extract_labels() %>% 
  calc_centroids()

# Pre-visualize ----
cases_pal <- leaflet::colorNumeric("Reds", dengue_clusters@data$ncases)

area_pal <- leaflet::colorFactor(RColorBrewer::brewer.pal(length(planning_areas), "Set3"), NULL)
```

## Dengue Clusters with Planning Areas and Climate Stations Overlay

```{r, geo_visualize, echo=FALSE}
dengue_clusters %>% 
  leaflet::leaflet(width = "100%") %>%
  leaflet::addTiles() %>%
  leaflet::addPolygons(data = planning_areas,
                       stroke = T,
                       opacity = 1,
                       smoothFactor = 0.5,
                       fillOpacity = 0.5,
                       fillColor = ~area_pal(parea),
                       weight = 0.5,
                       popup = ~as.character(parea)) %>%
  leaflet::addPolygons(stroke = T,
                       opacity = 5,
                       color = "black",
                       weight = 0.5,
                       smoothFactor = 0.5,
                       fillOpacity = 0.5,
                       fillColor = ~cases_pal(ncases),
                       label = ~as.character(ncases),
                       popup = ~as.character(ncases)) %>%
  leaflet::addCircleMarkers(data = dengue_cases,
                            lng = ~cx,
                            lat = ~cy,
                            radius = 5,
                            color = "red",
                            fillOpacity = 0.5,
                            clusterOptions = leaflet::markerClusterOptions()) %>%
  leaflet::addMarkers(data = climate_stations,
                      lng = ~Long,
                      lat = ~Lat,
                      popup = ~as.character(Station),
                      label = ~as.character(Station),
                      labelOptions = leaflet::labelOptions(noHide = F))
```

---
