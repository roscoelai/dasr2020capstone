---
title: "Capstone Project Proposal:\nAnalysing Dengue Cases in Singapore"
author: "S, R, A"
date: "04 July 2020"
output:
  ioslides_presentation:
    smaller: true
---

<!-- References (if we need some guidance) -->
<!-- https://bookdown.org/yihui/rmarkdown/presentations.html -->
<!-- https://rmarkdown.rstudio.com/authoring_basics.html -->

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

setwd(dirname(rstudioapi::getActiveDocumentContext()$path))

library(magrittr)
```

---

```{r, import, fig.cap="", echo=FALSE, include=FALSE}
library(ggplot2)

bulletin <- readr::read_csv("../data/weekly-infectious-disease-bulletin-cases/weekly-infectious-disease-bulletin-cases.csv")
```

```{r, explore_ncases_eweeks, fig.cap="", echo=FALSE, fig.width=8, fig.height=6}
bulletin %>% 
  dplyr::filter(grepl("Dengue", disease)) %>%
  # dplyr::filter(disease == "Dengue Fever") %>% 
  ggplot(aes(x = 1:nrow(.), y = no._of_cases, color = disease)) + 
  scale_x_continuous(breaks = c(1 + 104 * (0:8)),  # 104 because there's 2 rows per eweek
                     label = c(2012:2020)) + 
  geom_line(size = 1) + 
  labs(title = "Number of Dengue cases of over time from 2012-W01 to 2020-W20",
       subtitle = "Worrying trend - We might set a record this year!",
       x = "Time (from 2012-W01 to 2020-W20)",
       y = "Number of Cases",
       caption = "Source: Data.gov.sg")
```



## Overview of the Project {data-background=https://research.a-star.edu.sg/cms/figure/index/55e43a55140ba0db748b4b69.jpg data-background-size=auto data-background-position="right top"}
### Questions
  - Does atmospheric variables influence the incidence of dengue cases?
    - Specifically, is higher humidity, precipitation, or temperature (X) associated with increased numbers of dengue cases (Y)?
  - Can atmospheric variables predict the number of dengue cases?
  - Does the number of dengue cases increase with the number of COVID-19 cases?
  - Explain the different number of cases in different regions of Singapore.

## Overview of the Project (checklist)
### If we've covered the following then is K
- [ ] Why the question matters
  - Dengue infections -> severe medical condition -> ...
  - This year might be the worst...
- [ ] Why the findings are plausible
  - Rainfall, temperature -> mosquito growth -> ...
- [x] What will be investigated
- [ ] What the outcome of the investigation will be
- [ ] Identify your questions (explorative/predictive) in the format of the relationships between X and Y (correlational/causational)



## Data
- Weather data
  - Daily records from [Meteorological Service Singapore (MSS)](http://www.weather.gov.sg/climate-historical-daily/)
  - Air Temperature And Sunshine, Relative Humidity And Rainfall, Monthly from [Singapore Department of Statistics (DOS)](https://www.tablebuilder.singstat.gov.sg/publicfacing/api/csv/title/15306.csv)
- Number of cases by epidemiological weeks
  - [Data.gov.sg](https://data.gov.sg/dataset?q=Dengue) (2012-W01 to 2020-W20)
  - [Ministry of Health](https://www.moh.gov.sg/docs/librariesprovider5/diseases-updates/weekly-infectious-disease-bulletin-year-2020ea2c0b1cec1549009844537d52f2377f.xlsx) (2012-W01 to 2020-W25)
- Coordinates of zones with numbers of cases (past 14 days)
  - [Data.gov.sg](https://data.gov.sg/dataset?q=Dengue)
- COVID-19 cases (Apr - Jul 2020)
  - ?
- Population distribution across named regions (not coordinates) (2011 to 2019, yearly)
  - respopagesextod2011to2019.csv

## Data (checklist)
### If we've covered the following then is K
- [ ] Provide descriptions of your data
  - After we finalize which datasets we're using...
- [x] Where you will find it or have found it
- [x] How you will secure or have secured access (to import the data)
  - Webscrape, then save, then upload to GitHub
- [ ] What key variables are available within your dataset(s) for your analyses
  - Expand point 1 above



## Analysis Plan
- Combining datasets (standardize timeframe and resolution)
  - Converting dates to epidemiological weeks (lubridate::epiweeks())
  - Converting epidemiological weeks to months
- Number of dengue cases ~ Humidity, Precipitation, Temperature, ...
- Limitations
  - Time lag: Dengue cases manifest 1-2 weeks after infection
    - So, adjust timings for different datasets accordingly
  - Seasonal effects
    - "Vector" months (June, July, August, September, October)
  - COVID-19 cases vs. dengue cases
    - 90% foreign workers -> expect correlation
    - Number of cases from Apr - Jul 2020

## Analysis Plan
- [ ] How you will transform your datasets to come up with proxies of your X and Y
- [ ] Further elaborate and identify what would be your analysis
- [ ] How your analyses answer your proposed questions
- [ ] What the limits of your analyses would be
- [x] You might want to ponder alternative accounts to your proposed explanation of the phenomena that you analyzed



```{r collect, echo=FALSE, include=FALSE}
get_dos_monthly <- function() {
  #' Get Monthly Weather Records from Singapore Department of Statistics (DOS)
  #' 
  #' @description
  #' Air Temperature And Sunshine, Relative Humidity And Rainfall, Monthly.
  #' 
  #' It's just a single file. But it's wide form, need to tidy.
  #' 
  #' @details https://www.tablebuilder.singstat.gov.sg/publicfacing/api/csv/title/15306.csv
  #' 
  #' @return A table containing the combined historical monthly records.
  #' @examples
  #' get_dos_monthly()
  url = "https://www.tablebuilder.singstat.gov.sg/publicfacing/api/csv/title/15306.csv"
  
  readr::read_csv(url, na = c("", "na"), skip = 1, n_max = 10) %>% 
    tidyr::gather("year_month", "value", -Variables) %>% 
    dplyr::mutate(date = lubridate::ymd(paste(year_month, "01")),
                  year = lubridate::year(date),
                  month = lubridate::month(date),
                  Variables = gsub("\\s", "_", Variables)) %>% 
    dplyr::select(-c(year_month, date)) %>% 
    tidyr::spread(Variables, value) %>% 
    setNames(., c("Year",
                  "Month",
                  "24_Hours_Mean_Relative_Humidity_percent",
                  "Air_Temperature_Absolute_Extremes_Maximum_degC",
                  "Air_Temperature_Absolute_Extremes_Minimum_degC",
                  "Air_Temperature_Means_Daily_Maximum_degC",
                  "Air_Temperature_Means_Daily_Minimum_degC",
                  "Bright_Sunshine_Daily_Mean_hour",
                  "Highest_Daily_Rainfall_Total_mm",
                  "Minimum_Relative_Humidity_percent",
                  "Number_Of_Rainy_Days",
                  "Total_Rainfall_mm"))
}

get_mss_daily <- function(years) {
  #' Get Daily Records from Meteorological Service Singapore (MSS)
  #' 
  #' @description
  #' The Changi station (S24) is hard-coded here.
  #' 
  #' Available data ranges from Jan 1980 to May 2020.
  #' 
  #' @details http://www.weather.gov.sg/climate-historical-daily/
  #' 
  #' @param years A vector of years of interest.
  #' @return A table containing the combined historical daily records.
  #' @examples
  #' get_mss_daily(2014:2018)
  #' get_mss_daily(2014:2020)
  urls = paste0("http://www.weather.gov.sg/files/dailydata/DAILYDATA_S24_", 
                t(outer(years, sprintf("%02d", 1:12), FUN = paste0)), 
                ".csv")
  
  # There's no data beyond May 2020 (at the moment), so remove the last 7
  #   months if 2020 is included
  if (2020 %in% years) {
    urls = urls[1:(length(urls) - 7)]
  }
  
  myreader <- function(s) {
    readr::read_csv(s) %>% 
      # The "degree sign" in column headers are invalid multibyte characters
      # Data after Apr 2020 have slightly different column names
      # This would complicate joining the tables together
      # So, it might be better to manually label all column names
      setNames(., c("Station",
                    "Year",
                    "Month",
                    "Day",
                    "Daily_Rainfall_Total_mm",
                    "Highest_30_Min_Rainfall_mm",
                    "Highest_60_Min_Rainfall_mm",
                    "Highest_120_Min_Rainfall_mm",
                    "Mean_Temperature_degC",
                    "Maximum_Temperature_degC",
                    "Minimum_Temperature_degC",
                    "Mean_Wind_Speed_kmh",
                    "Max_Wind_Speed_kmh")) %>% 
      # The "long dashes" (em dash?) representing missing values are invalid
      #   multibyte characters and are replaced with NA (by coercion)
      dplyr::mutate_at(dplyr::vars(-Station), as.numeric)
  }
  
  dplyr::bind_rows(lapply(urls, myreader))
}

# s_data <- get_dos_monthly()
# w_data <- get_mss_daily(years = 2014:2020)

s_data <- readr::read_csv("../results/weather_monthly_1975_2020.csv")
w_data <- readr::read_csv("../results/weather_daily_2014_2020.csv")
```

## Monthly Weather Data
```{r inspect1, comment="", size="tiny"}
dplyr::glimpse(s_data)
```

## Daily Weather Data
```{r inspect2, comment="", size="tiny"}
dplyr::glimpse(w_data)
```

```{r, explore_weather1, echo=FALSE, fig.cap="", fig.width=8, fig.height=6}
s1 <- s_data %>%
  dplyr::filter(Year >= 2014 & Year <= 2018) %>%
  ggplot(aes(x = 1:nrow(.), y = Total_Rainfall_mm)) + 
  scale_x_continuous(breaks = c(1 + 12 * (0:4)),
                     label = c(2014:2018)) + 
  geom_line(size = 1) + 
  labs(title = "Total Monthly Rainfall from 2014 to 2018",
       subtitle = "Are we getting more water?",
       x = "Time (from 2014 to 2018)",
       y = "Total Monthly Rainfal (mm)",
       caption = "Source: singstat.gov.sg")

s2 <- s_data %>%
  dplyr::filter(Year >= 2014 & Year <= 2018) %>%
  ggplot(aes(x = 1:nrow(.), y = Air_Temperature_Means_Daily_Maximum_degC)) + 
  scale_x_continuous(breaks = c(1 + 12 * (0:4)),
                     label = c(2014:2018)) + 
  geom_line(size = 1) + 
  labs(title = "Air Temperature Means Daily Maximum from 2014 to 2018",
       subtitle = "",
       x = "Time (from 2014 to 2018)",
       y = "Air Temperature Means Daily Maximum (degC)",
       caption = "Source: singstat.gov.sg")

gridExtra::grid.arrange(s1, s2, nrow = 2)
```

```{r, explore_weather2, echo=FALSE, fig.cap="", fig.width=8, fig.height=6}
# dplyr::glimpse(w_data)
# 
# w_data %>% 
#   dplyr::filter(Year == 2014) %>%
#   dplyr::mutate(Year.f = as.factor(Year),
#                 Month.f = as.factor(Month)) %>% 
#   ggplot(aes(x = Day, y = Daily_Rainfall_Total_mm, color = Month.f)) + 
#   geom_line(size = 1)
```
